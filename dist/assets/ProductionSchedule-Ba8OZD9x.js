import{C as h,a$ as f,e as D,h as p,b0 as o,m,b1 as l,a as _,bc as n,bH as c,bI as S,bh as g,n as v}from"./index-Djh35xFL.js";const y={name:"production-schedule",components:{ComboboxNumber:h,Datepicker:f,Schedule:D,TaskInfo:p},data(){return{currentTask:null,endDate:o().add(6,"months").endOf("day"),scheduleItems:[],startDate:o().startOf("day"),selectedStartDate:null,selectedEndDate:null,zoomLevel:1,zoomOptions:[{label:"Week",value:0},{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}],loading:{schedule:!1},errors:{schedule:!1}}},mounted(){this.reset()},computed:{...m(["assetTypeMap","currentEpisode","currentProduction","isCurrentUserAdmin","isCurrentUserManager","isCurrentUserSupervisor","isTVShow","organisation","taskTypeMap","user"]),locale(){return this.user.locale==="fr_FR"?l.fr:l.en}},methods:{..._(["editProduction","loadAssetTypeScheduleItems","loadEpisodeScheduleItems","loadMilestones","loadScheduleItems","loadSequenceScheduleItems","saveScheduleItem"]),loadData(){this.loading.schedule=!0,this.loadScheduleItems(this.currentProduction).then(e=>{const t=n(this.selectedStartDate),a=n(this.selectedEndDate);e=e.map(s=>{const r=this.taskTypeMap.get(s.task_type_id);let d,i;s.start_date?d=n(s.start_date):d=o(),d.isSameOrAfter(a)&&(d=a.clone().add(-1,"days")),d.isBefore(t)&&(d=t.clone()),s.end_date?i=n(s.end_date):i=d.clone().add(1,"days"),i.isSameOrAfter(a)&&(i=a.clone());const u=c(r.id,this.currentProduction.id,this.currentEpisode?this.currentEpisode.id:null,r.for_entity);return{...s,color:r.color,for_entity:r.for_entity,name:r.name,priority:r.priority,startDate:d,endDate:i,editable:this.isInDepartment(r),expanded:!1,loading:!1,route:r.for_entity==="Shot"&&this.isTVShow?null:u,children:[]}}),this.scheduleItems=S(e,this.currentProduction,this.taskTypeMap),this.loading.schedule=!1}).then(this.loadMilestones).catch(e=>{console.error(e),this.loading.schedule=!1})},reset(){this.currentProduction.start_date&&(this.startDate=n(this.currentProduction.start_date)),this.currentProduction.end_date&&(this.endDate=n(this.currentProduction.end_date)),this.selectedStartDate=this.startDate.toDate(),this.selectedEndDate=this.endDate.toDate(),this.loadData()},convertScheduleItems(e,t){return t.map(a=>{let s,r;a.start_date?s=n(a.start_date):s=o(),e&&s.isBefore(e.startDate)&&(s=e.startDate.clone()),e&&s.isAfter(e.endDate)&&(s=e.endDate.clone().add(-1,"days")),a.end_date?r=n(a.end_date):r=s.clone().add(1,"days"),r.isBefore(s)&&(r=s.clone().add(1,"days"));const d={...a,startDate:s,endDate:r,expanded:!1,loading:!1,editable:this.isInDepartment(this.taskTypeMap.get(a.task_type_id)),children:[],parentElement:e};return this.isTVShow&&(d.route=c(a.task_type_id,this.currentProduction.id,a.object_id,e.for_entity)),d})},expandTaskTypeElement(e){const t={production:this.currentProduction,taskType:this.taskTypeMap.get(e.task_type_id)};if(e.expanded=!e.expanded,e.expanded){e.loading=!0;let a="loadAssetTypeScheduleItems";e.for_entity==="Shot"&&(this.isTVShow?a="loadEpisodeScheduleItems":a="loadSequenceScheduleItems"),this[a](t).then(s=>{e.loading=!1,e.children=this.convertScheduleItems(e,s)}).catch(s=>{console.error(s),e.loading=!1,e.children=[]})}},estimationChanged({item:e,days:t}){e.man_days=g(this.organisation,t),this.saveScheduleItem(e)},scheduleItemChanged(e){if(e.startDate&&e.endDate&&e.parentElement)e.parentElement.startDate=this.getMinDate(e.parentElement),e.parentElement.endDate=this.getMaxDate(e.parentElement),this.saveScheduleItem(e.parentElement);else if(!e.parentElement){const t=this.getMinDate(e),a=this.getMaxDate(e);e.startDate.isAfter(t)&&(e.startDate=t),e.endDate.isBefore(a)&&(e.endDate=a.add(-1,"days"))}this.saveScheduleItem(e)},getMinDate(e){let t=this.endDate.clone();return e.children.forEach(a=>{a.startDate&&a.startDate.isBefore(t)&&(t=a.startDate)}),t.clone()},getMaxDate(e){let t=this.startDate.clone();return e.children.forEach(a=>{a.endDate&&a.endDate.isAfter(t)&&(t=a.endDate)}),t.clone()},isInDepartment(e){return this.isCurrentUserManager?!0:this.isCurrentUserSupervisor?this.user.departments.length===0?!0:e.department_id&&this.user.departments.includes(e.department_id):!1}},socket:{},watch:{selectedStartDate(){this.startDate=n(this.selectedStartDate);const e=this.startDate.format("YYYY-MM-DD");this.currentProduction.start_date&&this.currentProduction.start_date!==e&&this.editProduction({...this.currentProduction,start_date:e})},selectedEndDate(){this.endDate=n(this.selectedEndDate);const e=this.endDate.format("YYYY-MM-DD");this.currentProduction.end_date&&this.currentProduction.end_date!==e&&this.editProduction({...this.currentProduction,end_date:e})},currentProduction(){this.reset()}},metaInfo(){return{title:`${this.currentProduction.name} | ${this.$t("schedule.title")} - Kitsu`}}};var b=function(){var t=this,a=t._self._c;return a("div",{staticClass:"columns fixed-page"},[a("div",{staticClass:"column main-column"},[a("div",{staticClass:"flexrow project-dates"},[a("div",{staticClass:"flexrow-item"},[a("label",{staticClass:"label"},[t._v(" "+t._s(t.$t("main.start_date"))+" ")]),a("datepicker",{attrs:{"wrapper-class":"datepicker","input-class":"date-input input short",language:t.locale,"disabled-dates":{days:[6,0]},"monday-first":!0,format:"yyyy-MM-dd"},model:{value:t.selectedStartDate,callback:function(s){t.selectedStartDate=s},expression:"selectedStartDate"}})],1),a("div",{staticClass:"flexrow-item field"},[a("label",{staticClass:"label"},[t._v(" "+t._s(t.$t("main.end_date"))+" ")]),a("datepicker",{attrs:{"wrapper-class":"datepicker","input-class":"date-input input short",language:t.locale,"disabled-dates":{days:[6,0]},"monday-first":!0,format:"yyyy-MM-dd"},model:{value:t.selectedEndDate,callback:function(s){t.selectedEndDate=s},expression:"selectedEndDate"}})],1),a("combobox-number",{staticClass:"flexrow-item zoom-level",attrs:{label:t.$t("schedule.zoom_level"),options:t.zoomOptions},model:{value:t.zoomLevel,callback:function(s){t.zoomLevel=s},expression:"zoomLevel"}})],1),a("schedule",{attrs:{"start-date":t.startDate,"end-date":t.endDate,hierarchy:t.scheduleItems,"zoom-level":t.zoomLevel,"is-loading":t.loading.schedule,"is-error":t.errors.schedule,"hide-man-days":!0},on:{"item-changed":t.scheduleItemChanged,"estimation-changed":t.estimationChanged,"root-element-expanded":t.expandTaskTypeElement}})],1),t.currentTask?a("div",{staticClass:"column side-column is-hidden-mobile hide-small-screen"},[a("task-info",{attrs:{task:t.currentTask,"is-loading":!1}})],1):t._e()])},x=[],I=v(y,b,x,!1,null,"f471540c",null,null);const P=I.exports;export{P as default};
//# sourceMappingURL=ProductionSchedule-Ba8OZD9x.js.map

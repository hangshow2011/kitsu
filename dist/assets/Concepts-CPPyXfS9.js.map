{"version":3,"file":"Concepts-CPPyXfS9.js","sources":["../../src/components/pages/Concepts.vue"],"sourcesContent":["<template>\n  <div class=\"fixed-page columns\">\n    <div class=\"column main-column\">\n      <div class=\"concepts page\">\n        <div class=\"page-header\">\n          <div class=\"filters\">\n            <search-field\n              ref=\"search-field\"\n              class=\"field\"\n              :can-save=\"true\"\n              placeholder=\"ex: chara\"\n              @change=\"onSearchChange\"\n              @save=\"saveSearchQuery\"\n              v-if=\"false\"\n            />\n            <combobox-status\n              :label=\"$t('main.status')\"\n              :task-status-list=\"taskStatusList\"\n              v-model=\"filters.taskStatusId\"\n            />\n            <span class=\"field small\">\n              <label class=\"label\">\n                {{ $t('concepts.fields.publisher') }}\n              </label>\n              <people-field\n                :big=\"true\"\n                :people=\"publishers\"\n                v-model=\"filters.publisher\"\n              />\n            </span>\n            <combobox\n              :label=\"$t('concepts.fields.entity_type')\"\n              :options=\"entityTypeOptions\"\n              v-model=\"filters.entityType\"\n              v-if=\"false\"\n            />\n            <combobox\n              class=\"right\"\n              :label=\"$t('main.sorted_by')\"\n              locale-key-prefix=\"concepts.fields.\"\n              :options=\"sortByOptions\"\n              v-model=\"filters.sortBy\"\n            />\n          </div>\n          <div class=\"query-list\" v-if=\"false\">\n            <search-query-list\n              :queries=\"conceptSearchQueries\"\n              type=\"concept\"\n              @change-search=\"changeSearch\"\n              @remove-search=\"removeSearchQuery\"\n            />\n          </div>\n        </div>\n        <table-info\n          :is-loading=\"loading.loadingConcepts\"\n          :is-error=\"errors.loadingConcepts\"\n          v-if=\"loading.loadingConcepts || errors.loadingConcepts\"\n        />\n        <div\n          ref=\"concept-list\"\n          class=\"concept-list pb1\"\n          @dragover=\"onFileDragover\"\n          v-else-if=\"filteredConcepts?.length\"\n        >\n          <div\n            class=\"drop-mask\"\n            @drop=\"onFileDrop\"\n            @dragover=\"onFileDragover\"\n            @dragleave=\"onFileDragLeave\"\n            v-if=\"isDraggingFile\"\n          >\n            Drop new concepts\n          </div>\n          <ul class=\"items\">\n            <li\n              class=\"item\"\n              :class=\"{\n                'selected-item': isSelected(concept)\n              }\"\n              v-for=\"concept in filteredConcepts\"\n              :key=\"concept.id\"\n              @click=\"\n                onSelectConcept(concept, $event.ctrlKey || $event.metaKey)\n              \"\n            >\n              <concept-card :concept=\"concept\" />\n            </li>\n          </ul>\n        </div>\n        <div class=\"has-text-centered mb1 mt1 empty-concepts\" v-else>\n          <strong>\n            {{ $t('concepts.empty') }}\n          </strong>\n        </div>\n        <div class=\"footer mb2\">\n          <button-simple\n            class=\"upload-button\"\n            :disabled=\"loading.loadingConcepts\"\n            :text=\"$t('concepts.add_new_concept')\"\n            @click=\"openAddConceptModal\"\n          />\n        </div>\n      </div>\n    </div>\n\n    <add-preview-modal\n      ref=\"add-preview-modal\"\n      :active=\"modals.addConcept\"\n      :extensions=\"imgExtensions\"\n      is-concept\n      :is-error=\"errors.addingConcept\"\n      :is-loading=\"loading.addingConcept\"\n      message=\"\"\n      @cancel=\"closeAddConceptModal\"\n      @confirm=\"confirmAddConceptModal\"\n    />\n\n    <div class=\"column side-column\">\n      <task-info entity-type=\"Concept\" :task=\"currentTask\" with-actions />\n    </div>\n  </div>\n</template>\n\n<script>\nimport { mapGetters, mapActions } from 'vuex'\nimport { firstBy } from 'thenby'\n\nimport { sortByName, sortPeople } from '@/lib/sorting'\n\nimport { searchMixin } from '@/components/mixins/search'\nimport { domMixin } from '@/components/mixins/dom'\n\nimport files from '@/lib/files'\n\nimport AddPreviewModal from '@/components/modals/AddPreviewModal'\nimport ButtonSimple from '@/components/widgets/ButtonSimple'\nimport Combobox from '@/components/widgets/Combobox.vue'\nimport ComboboxStatus from '@/components/widgets/ComboboxStatus.vue'\nimport ConceptCard from '@/components/widgets/ConceptCard'\nimport PeopleField from '@/components/widgets/PeopleField'\nimport SearchField from '@/components/widgets/SearchField'\nimport SearchQueryList from '@/components/widgets/SearchQueryList'\nimport TableInfo from '@/components/widgets/TableInfo'\nimport TaskInfo from '@/components/sides/TaskInfo'\n\nexport default {\n  name: 'concepts',\n  mixins: [searchMixin, domMixin],\n\n  components: {\n    AddPreviewModal,\n    ButtonSimple,\n    Combobox,\n    ComboboxStatus,\n    ConceptCard,\n    PeopleField,\n    SearchField,\n    SearchQueryList,\n    TableInfo,\n    TaskInfo\n  },\n\n  data() {\n    return {\n      imgExtensions: files.IMG_EXTENSIONS_STRING,\n      isDraggingFile: false,\n      loading: {\n        addingConcept: false,\n        loadingConcepts: false,\n        savingSearch: false\n      },\n      errors: {\n        addingConcept: false,\n        loadingConcepts: false\n      },\n      filters: {\n        entityType: null,\n        publisher: null,\n        sortBy: 'created_at',\n        taskStatusId: null\n      },\n      form: {\n        file: null\n      },\n      modals: {\n        addConcept: false\n      },\n\n      // TODO: module getters\n      conceptSearchQueries: [\n        {\n          id: 'filter-test-1',\n          list_type: 'concept',\n          name: 'test',\n          search_query: 'test'\n        }\n      ]\n    }\n  },\n\n  mounted() {\n    // TODO: concept search\n    // this.setSearch(this.$route.query.search)\n    // this.searchField.focus()\n  },\n\n  computed: {\n    ...mapGetters([\n      'assetMap',\n      'currentProduction',\n      'displayedConcepts',\n      'isDarkTheme',\n      'isTVShow',\n      'personMap',\n      'selectedConcepts',\n      'taskStatusMap'\n    ]),\n\n    publishers() {\n      const publishers = new Map()\n      this.filteredConcepts.forEach(concept => {\n        const personId = concept.created_by\n        if (!publishers.has(personId)) {\n          const person = this.personMap.get(personId)\n          if (person) {\n            publishers.set(personId, person)\n          }\n        }\n      })\n      return sortPeople([...publishers.values()])\n    },\n\n    currentTask() {\n      return this.currentConcept?.tasks?.[0]\n    },\n\n    currentConcept() {\n      return this.selectedConcepts.size === 1\n        ? this.selectedConcepts.values().next().value\n        : null\n    },\n\n    entityTypeOptions() {\n      const allEntityTypeOptions = {\n        label: this.$t('main.all'),\n        value: null\n      }\n      const options = ['assets', 'shots', 'sequences', 'edits', 'episodes'].map(\n        name => ({\n          label: this.$t(`${name}.title`),\n          value: name\n        })\n      )\n      return [allEntityTypeOptions].concat(options)\n    },\n\n    sortByOptions() {\n      return ['created_at', 'updated_at', 'last_comment_date'].map(name => ({\n        label: name,\n        value: name\n      }))\n    },\n\n    filteredConcepts() {\n      let concepts = [...this.displayedConcepts]\n\n      if (this.filters.taskStatusId) {\n        concepts = concepts.filter(\n          concept =>\n            concept.tasks[0].task_status_id === this.filters.taskStatusId\n        )\n      }\n      if (this.filters.publisher) {\n        concepts = concepts.filter(\n          concept => concept.created_by === this.filters.publisher.id\n        )\n      }\n      if (this.filters.entityType) {\n        concepts = concepts.filter(concept =>\n          concept.tags?.some(\n            // FIXME: condition related to many-to-many relationship\n            entity => entity.type === this.filters.entityType\n          )\n        )\n      }\n      return concepts.sort(\n        firstBy(this.filters.sortBy, -1).thenBy('created_at', -1)\n      )\n    },\n\n    searchField() {\n      return this.$refs['search-field']\n    },\n\n    taskStatusList() {\n      const allStatusItem = {\n        id: null,\n        color: '#999',\n        name: this.$t('main.all'),\n        short_name: this.$t('main.all')\n      }\n      const conceptTaskStatusList = sortByName(\n        Array.from(this.taskStatusMap.values()).filter(\n          status => status.for_concept\n        )\n      )\n      return [allStatusItem].concat(conceptTaskStatusList)\n    }\n  },\n\n  methods: {\n    ...mapActions([\n      'addSelectedConcepts',\n      'addSelectedTask',\n      'clearSelectedConcepts',\n      'clearSelectedTasks',\n      'loadAssets',\n      'loadConcepts',\n      'newConcepts',\n      'setCurrentEpisode'\n    ]),\n\n    // TODO: module actions\n    setConceptSearch: searchQuery => Promise.resolve(),\n    saveConceptSearch: searchQuery => Promise.resolve(),\n    removeConceptSearch: searchQuery => Promise.resolve(),\n\n    setSearch(value) {\n      this.searchField.setValue(value)\n    },\n\n    onSearchChange() {\n      const searchQuery = this.searchField.getValue() || ''\n      if (searchQuery?.length !== 1) {\n        this.setConceptSearch(searchQuery)\n      }\n      this.setSearchInUrl()\n    },\n\n    saveSearchQuery(searchQuery) {\n      if (this.loading.savingSearch) {\n        return\n      }\n      this.loading.savingSearch = true\n      this.saveConceptSearch(searchQuery)\n        .catch(console.error)\n        .finally(() => {\n          this.loading.savingSearch = false\n        })\n    },\n\n    removeSearchQuery(searchQuery) {\n      this.removeConceptSearch(searchQuery).catch(err => {\n        if (err) console.error(err)\n      })\n    },\n\n    async refreshConcepts() {\n      this.loading.loadingConcepts = true\n      try {\n        this.setCurrentEpisode('all') // mandatory to load all assets\n        await this.loadAssets(true)\n        await this.loadConcepts()\n      } catch (err) {\n        console.error(err)\n        this.errors.loadingConcepts = true\n      } finally {\n        this.loading.loadingConcepts = false\n      }\n    },\n\n    isSelected(concept) {\n      return this.selectedConcepts.has(concept.id)\n    },\n\n    onSelectConcept(concept, isMultipleSelection = false) {\n      const selection = isMultipleSelection\n        ? new Map(this.selectedConcepts)\n        : new Map()\n      if (\n        (isMultipleSelection && this.isSelected(concept)) ||\n        (!isMultipleSelection && concept === this.currentConcept)\n      ) {\n        selection.delete(concept.id)\n      } else {\n        selection.set(concept.id, concept)\n      }\n      this.clearSelectedConcepts()\n      this.addSelectedConcepts(selection)\n\n      this.clearSelectedTasks()\n      if (this.currentTask) {\n        this.addSelectedTask(this.currentTask)\n      }\n    },\n\n    openAddConceptModal() {\n      this.modals.addConcept = true\n    },\n\n    closeAddConceptModal() {\n      this.modals.addConcept = false\n    },\n\n    async confirmAddConceptModal(forms) {\n      this.loading.addingConcept = true\n      try {\n        await this.newConcepts(forms)\n        this.closeAddConceptModal()\n      } catch (err) {\n        console.error(err)\n        this.errors.addingConcept = true\n      } finally {\n        this.loading.addingConcept = false\n      }\n    },\n\n    reset() {\n      this.clearSelectedConcepts()\n      this.clearSelectedTasks()\n      this.refreshConcepts()\n    },\n\n    onFileDrop(event) {\n      this.pauseEvent(event)\n      const files = event.dataTransfer.files\n      this.modals.addConcept = true\n      this.isDraggingFile = false\n      this.$nextTick(() => {\n        this.$refs['add-preview-modal'].setFiles(files)\n      })\n    },\n\n    onFileDragover(event) {\n      this.pauseEvent(event)\n      this.isDraggingFile = true\n    },\n\n    onFileDragLeave() {\n      this.isDraggingFile = false\n    }\n  },\n\n  watch: {\n    currentProduction: {\n      immediate: true,\n      handler() {\n        // HACK: the store init a wrong current production by default\n        const productionId = this.$route.params.production_id\n        if (this.currentProduction?.id === productionId) {\n          this.reset()\n        }\n      }\n    }\n  },\n\n  metaInfo() {\n    return {\n      title: `${this.$t('concepts.title')} - Kitsu`\n    }\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.concepts {\n  display: flex;\n  flex-direction: column;\n  overflow: hidden;\n}\n\n.filters {\n  display: flex;\n  align-items: flex-end;\n  gap: 0 20px;\n  padding: 10px;\n\n  .field {\n    margin-bottom: 1em;\n\n    .label {\n      padding-top: 5px;\n    }\n  }\n\n  .right {\n    margin-left: auto;\n  }\n}\n\n.concept-list {\n  flex: 1;\n  margin: 0 auto;\n  position: relative;\n  overflow-y: auto;\n}\n\n.items {\n  cursor: pointer;\n  display: flex;\n  flex-wrap: wrap;\n  gap: 20px;\n  list-style: none;\n  margin: 0;\n\n  .item {\n    display: flex;\n    flex-direction: column;\n    background-color: var(--background);\n    border-radius: 1em;\n\n    border: 5px solid transparent;\n    transition: border-color 0.2s ease-in-out;\n\n    &:hover {\n      border-color: var(--background-selectable);\n    }\n\n    &.selected-item {\n      border-color: var(--background-selected);\n    }\n  }\n}\n\n.page-header {\n  margin-top: 0;\n  padding: 0;\n}\n\n.footer {\n  background: transparent;\n  position: sticky;\n  bottom: 0;\n  display: flex;\n  justify-content: center;\n  padding: 5px;\n\n  .button {\n    border-radius: 10px;\n    font-size: 1.2em;\n    height: 50px;\n    transition: background-color 0.1s ease-in-out;\n    width: 100%;\n\n    &:hover {\n      background-color: var(--background-hover);\n    }\n  }\n}\n\n.drop-mask {\n  background: rgba(0.1, 0, 0, 0.5);\n  border-radius: 0.5em;\n  color: white;\n  font-size: 2em;\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 100;\n}\n\n.empty-concepts {\n  flex: 1;\n}\n</style>\n"],"names":["_sfc_main","searchMixin","domMixin","AddPreviewModal","ButtonSimple","Combobox","ComboboxStatus","ConceptCard","PeopleField","SearchField","SearchQueryList","TableInfo","TaskInfo","files","mapGetters","publishers","concept","personId","person","sortPeople","_b","_a","allEntityTypeOptions","options","name","concepts","entity","firstBy","allStatusItem","conceptTaskStatusList","sortByName","status","mapActions","searchQuery","value","err","isMultipleSelection","selection","forms","event","productionId"],"mappings":"mNAiJA,MAAAA,EAAA,CACA,KAAA,WACA,OAAA,CAAAC,EAAAC,CAAA,EAEA,WAAA,CACA,gBAAAC,EACA,aAAAC,EACA,SAAAC,EACA,eAAAC,EACA,YAAAC,EACA,YAAAC,EACA,YAAAC,EACA,gBAAAC,EACA,UAAAC,EACA,SAAAC,CACA,EAEA,MAAA,CACA,MAAA,CACA,cAAAC,EAAA,sBACA,eAAA,GACA,QAAA,CACA,cAAA,GACA,gBAAA,GACA,aAAA,EACA,EACA,OAAA,CACA,cAAA,GACA,gBAAA,EACA,EACA,QAAA,CACA,WAAA,KACA,UAAA,KACA,OAAA,aACA,aAAA,IACA,EACA,KAAA,CACA,KAAA,IACA,EACA,OAAA,CACA,WAAA,EACA,EAGA,qBAAA,CACA,CACA,GAAA,gBACA,UAAA,UACA,KAAA,OACA,aAAA,MACA,CACA,CACA,CACA,EAEA,SAAA,CAIA,EAEA,SAAA,CACA,GAAAC,EAAA,CACA,WACA,oBACA,oBACA,cACA,WACA,YACA,mBACA,eACA,CAAA,EAEA,YAAA,CACA,MAAAC,EAAA,IAAA,IACA,YAAA,iBAAA,QAAAC,GAAA,CACA,MAAAC,EAAAD,EAAA,WACA,GAAA,CAAAD,EAAA,IAAAE,CAAA,EAAA,CACA,MAAAC,EAAA,KAAA,UAAA,IAAAD,CAAA,EACAC,GACAH,EAAA,IAAAE,EAAAC,CAAA,CAEA,CACA,CAAA,EACAC,EAAA,CAAA,GAAAJ,EAAA,OAAA,CAAA,CAAA,CACA,EAEA,aAAA,SACA,OAAAK,GAAAC,EAAA,KAAA,iBAAA,YAAAA,EAAA,QAAA,YAAAD,EAAA,EACA,EAEA,gBAAA,CACA,OAAA,KAAA,iBAAA,OAAA,EACA,KAAA,iBAAA,SAAA,KAAA,EAAA,MACA,IACA,EAEA,mBAAA,CACA,MAAAE,EAAA,CACA,MAAA,KAAA,GAAA,UAAA,EACA,MAAA,IACA,EACAC,EAAA,CAAA,SAAA,QAAA,YAAA,QAAA,UAAA,EAAA,IACAC,IAAA,CACA,MAAA,KAAA,GAAA,GAAAA,CAAA,QAAA,EACA,MAAAA,CACA,EACA,EACA,MAAA,CAAAF,CAAA,EAAA,OAAAC,CAAA,CACA,EAEA,eAAA,CACA,MAAA,CAAA,aAAA,aAAA,mBAAA,EAAA,IAAAC,IAAA,CACA,MAAAA,EACA,MAAAA,CACA,EAAA,CACA,EAEA,kBAAA,CACA,IAAAC,EAAA,CAAA,GAAA,KAAA,iBAAA,EAEA,OAAA,KAAA,QAAA,eACAA,EAAAA,EAAA,OACAT,GACAA,EAAA,MAAA,CAAA,EAAA,iBAAA,KAAA,QAAA,YACA,GAEA,KAAA,QAAA,YACAS,EAAAA,EAAA,OACAT,GAAAA,EAAA,aAAA,KAAA,QAAA,UAAA,EACA,GAEA,KAAA,QAAA,aACAS,EAAAA,EAAA,OAAAT,GAAA,OACA,OAAAK,EAAAL,EAAA,OAAA,YAAAK,EAAA,KAEAK,GAAAA,EAAA,OAAA,KAAA,QAAA,YAEA,GAEAD,EAAA,KACAE,UAAA,KAAA,QAAA,OAAA,EAAA,EAAA,OAAA,aAAA,EAAA,CACA,CACA,EAEA,aAAA,CACA,OAAA,KAAA,MAAA,cAAA,CACA,EAEA,gBAAA,CACA,MAAAC,EAAA,CACA,GAAA,KACA,MAAA,OACA,KAAA,KAAA,GAAA,UAAA,EACA,WAAA,KAAA,GAAA,UAAA,CACA,EACAC,EAAAC,EACA,MAAA,KAAA,KAAA,cAAA,OAAA,CAAA,EAAA,OACAC,GAAAA,EAAA,WACA,CACA,EACA,MAAA,CAAAH,CAAA,EAAA,OAAAC,CAAA,CACA,CACA,EAEA,QAAA,CACA,GAAAG,EAAA,CACA,sBACA,kBACA,wBACA,qBACA,aACA,eACA,cACA,mBACA,CAAA,EAGA,iBAAAC,GAAA,QAAA,QAAA,EACA,kBAAAA,GAAA,QAAA,QAAA,EACA,oBAAAA,GAAA,QAAA,QAAA,EAEA,UAAAC,EAAA,CACA,KAAA,YAAA,SAAAA,CAAA,CACA,EAEA,gBAAA,CACA,MAAAD,EAAA,KAAA,YAAA,SAAA,GAAA,IACAA,GAAA,YAAAA,EAAA,UAAA,GACA,KAAA,iBAAAA,CAAA,EAEA,KAAA,eAAA,CACA,EAEA,gBAAAA,EAAA,CACA,KAAA,QAAA,eAGA,KAAA,QAAA,aAAA,GACA,KAAA,kBAAAA,CAAA,EACA,MAAA,QAAA,KAAA,EACA,QAAA,IAAA,CACA,KAAA,QAAA,aAAA,EACA,CAAA,EACA,EAEA,kBAAAA,EAAA,CACA,KAAA,oBAAAA,CAAA,EAAA,MAAAE,GAAA,CACAA,GAAA,QAAA,MAAAA,CAAA,CACA,CAAA,CACA,EAEA,MAAA,iBAAA,CACA,KAAA,QAAA,gBAAA,GACA,GAAA,CACA,KAAA,kBAAA,KAAA,EACA,MAAA,KAAA,WAAA,EAAA,EACA,MAAA,KAAA,aAAA,CACA,OAAAA,EAAA,CACA,QAAA,MAAAA,CAAA,EACA,KAAA,OAAA,gBAAA,EACA,QAAA,CACA,KAAA,QAAA,gBAAA,EACA,CACA,EAEA,WAAAnB,EAAA,CACA,OAAA,KAAA,iBAAA,IAAAA,EAAA,EAAA,CACA,EAEA,gBAAAA,EAAAoB,EAAA,GAAA,CACA,MAAAC,EAAAD,EACA,IAAA,IAAA,KAAA,gBAAA,EACA,IAAA,IAEAA,GAAA,KAAA,WAAApB,CAAA,GACA,CAAAoB,GAAApB,IAAA,KAAA,eAEAqB,EAAA,OAAArB,EAAA,EAAA,EAEAqB,EAAA,IAAArB,EAAA,GAAAA,CAAA,EAEA,KAAA,sBAAA,EACA,KAAA,oBAAAqB,CAAA,EAEA,KAAA,mBAAA,EACA,KAAA,aACA,KAAA,gBAAA,KAAA,WAAA,CAEA,EAEA,qBAAA,CACA,KAAA,OAAA,WAAA,EACA,EAEA,sBAAA,CACA,KAAA,OAAA,WAAA,EACA,EAEA,MAAA,uBAAAC,EAAA,CACA,KAAA,QAAA,cAAA,GACA,GAAA,CACA,MAAA,KAAA,YAAAA,CAAA,EACA,KAAA,qBAAA,CACA,OAAAH,EAAA,CACA,QAAA,MAAAA,CAAA,EACA,KAAA,OAAA,cAAA,EACA,QAAA,CACA,KAAA,QAAA,cAAA,EACA,CACA,EAEA,OAAA,CACA,KAAA,sBAAA,EACA,KAAA,mBAAA,EACA,KAAA,gBAAA,CACA,EAEA,WAAAI,EAAA,CACA,KAAA,WAAAA,CAAA,EACA,MAAA1B,EAAA0B,EAAA,aAAA,MACA,KAAA,OAAA,WAAA,GACA,KAAA,eAAA,GACA,KAAA,UAAA,IAAA,CACA,KAAA,MAAA,mBAAA,EAAA,SAAA1B,CAAA,CACA,CAAA,CACA,EAEA,eAAA0B,EAAA,CACA,KAAA,WAAAA,CAAA,EACA,KAAA,eAAA,EACA,EAEA,iBAAA,CACA,KAAA,eAAA,EACA,CACA,EAEA,MAAA,CACA,kBAAA,CACA,UAAA,GACA,SAAA,OAEA,MAAAC,EAAA,KAAA,OAAA,OAAA,gBACAnB,EAAA,KAAA,oBAAA,YAAAA,EAAA,MAAAmB,GACA,KAAA,MAAA,CAEA,CACA,CACA,EAEA,UAAA,CACA,MAAA,CACA,MAAA,GAAA,KAAA,GAAA,gBAAA,CAAA,UACA,CACA,CACA"}
import{a7 as c,aX as b,g as m,b0 as r,m as u,Y as l,bv as C,bw as L,bx as w,bu as h,cd as n,n as d,ce as S,i as x,a5 as D,s as p,a_ as I,J as y,bm as M,B as Y,o as O,ap as R,a as T,u as q,v as P}from"./index-Djh35xFL.js";import{B as j}from"./ButtonHrefLink-Bonp_Xzb.js";const N={name:"people-timesheet-list",components:{PeopleAvatar:c,PeopleName:b,TableInfo:m},data(){return{currentMonth:r().month()+1,currentYear:r().year(),currentWeek:r().week()}},props:{timesheet:{type:Object,default:()=>{}},people:{type:Array,default:()=>[]},detailLevel:{type:String,default:"day"},year:{type:Number,default:0},month:{type:Number,default:0},unit:{type:String,default:"hour"},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1}},computed:{...u(["dayOffMap","organisation","route"]),yearRange(){return l(2018,r().year())},monthRange(){return C(this.year,this.currentYear,this.currentMonth)},dayRange(){return L(this.year,this.month,this.currentYear,this.currentMonth)},weekRange(){return w(this.year,this.currentYear,this.currentWeek)},isHours(){return this.unit==="hour"}},methods:{monthToString:h,yearDuration(i,e){const t=`${i}`,s=this.getDuration(t,e);return this.isHours?s:n(this.organisation,s).toFixed(2)},monthDuration(i,e){const t=`${i}`,s=this.getDuration(t,e);return this.isHours?s:n(this.organisation,s).toFixed(2)},weekDuration(i,e){const t=this.getDuration(i,e);return this.isHours?t:n(this.organisation,t).toFixed(2)},dayDuration(i,e){var t;if(((t=this.dayOffMap[e])==null?void 0:t[`${i}`])===!0)return this.$t("timesheets.off").toUpperCase();{const s=this.getDuration(i,e);return this.isHours?s:n(this.organisation,s).toFixed(2)}},getDuration(i,e){return this.timesheet&&this.timesheet[i]&&this.timesheet[i][e]?this.timesheet[i][e]/60:"-"},isWeekend(i,e,t){const s=r(`${i}-${e}-${t}`,"YYYY-M-D");return[0,6].includes(s.day())},isDaySelected(i,e,t,s){return this.$route.params.person_id&&this.$route.params.person_id===i&&this.$route.params.year===e&&this.$route.params.month===t&&this.$route.params.day===s},isWeekSelected(i,e,t){return this.$route.params.person_id&&this.$route.params.person_id===i&&this.$route.params.year===e&&this.$route.params.week===t},isMonthSelected(i,e,t){return this.$route.params.person_id&&this.$route.params.person_id===i&&this.$route.params.year===e&&this.$route.params.month===t},isYearSelected(i,e){return this.$route.params.person_id&&this.$route.params.person_id===i&&this.$route.params.year===e},getWeekTitle(i){const e=r(this.currentYear+"-"+i,"YYYY-W"),t=e.clone().add(6,"days");return e.format("YYYY-MM-DD")+" - "+t.format("YYYY-MM-DD")},getYearDetailRoute(i,e){return{name:"timesheets-year-person",params:{person_id:i.id,year:e},query:{productionId:this.$route.query.productionId}}},getMonthDetailRoute(i,e,t){return{name:"timesheets-month-person",params:{person_id:i.id,year:e,month:t},query:{productionId:this.$route.query.productionId}}},getWeekDetailRoute(i,e,t){return{name:"timesheets-week-person",params:{person_id:i.id,year:e,week:t},query:{productionId:this.$route.query.productionId}}},getDayDetailRoute(i,e,t,s){return{name:"timesheets-day-person",params:{person_id:i.id,year:e,month:t,day:s},query:{productionId:this.$route.query.productionId}}},isDayOff(i,e){const t=`${e}`.padStart(2,"0");return this.dayOffMap[i]&&this.dayOffMap[i][t]}},watch:{route(){document.getElementsByClassName("selected").length===0&&(this.$refs.body.scrollLeft+=350)}}};var W=function(){var e=this,t=e._self._c;return t("div",{staticClass:"data-list"},[t("div",{ref:"body",staticClass:"datatable-wrapper"},[t("table",{staticClass:"datatable"},[t("thead",{staticClass:"datatable-head"},[t("tr",[t("th",{staticClass:"name datatable-row-header",attrs:{scope:"col"}},[e._v(" "+e._s(e.$t("people.list.name"))+" ")]),e._l(e.yearRange,function(s){return e.detailLevel==="year"?t("th",{key:`year-${s}`,staticClass:"time year",attrs:{scope:"col"}},[e._v(" "+e._s(s)+" ")]):e._e()}),e._l(e.monthRange,function(s){return e.detailLevel==="month"?t("th",{key:`month-${s}`,staticClass:"time month",attrs:{scope:"col"}},[e._v(" "+e._s(e.monthToString(s))+" ")]):e._e()}),e._l(e.weekRange,function(s){return e.detailLevel==="week"?t("th",{key:`week-${s}`,staticClass:"daytime",attrs:{scope:"col",title:e.getWeekTitle(s)}},[e._v(" "+e._s(s)+" ")]):e._e()}),e._l(e.dayRange,function(s){return e.detailLevel==="day"?t("th",{key:`day-${s}`,staticClass:"daytime",attrs:{scope:"col"}},[e._v(" "+e._s(s)+" ")]):e._e()}),t("th",{staticClass:"actions",attrs:{scope:"col"}})],2)]),e.isLoading?e._e():t("tbody",{staticClass:"datatable-body"},e._l(e.people,function(s){return t("tr",{key:s.id,staticClass:"datatable-row"},[t("th",{staticClass:"datatable-row-header name"},[t("div",{staticClass:"flexrow"},[t("people-avatar",{staticClass:"flexrow-item",attrs:{person:s}}),t("people-name",{staticClass:"flexrow-item",attrs:{"with-link":"",person:s}})],1)]),e._l(e.yearRange,function(a){return e.detailLevel==="year"?t("td",{key:`year-${a}-${s.id}`,staticClass:"time year",class:{selected:e.isYearSelected(s.id,a)}},[e.yearDuration(a,s.id)>0?t("router-link",{staticClass:"duration",attrs:{to:e.getYearDetailRoute(s,a)}},[e._v(" "+e._s(e.yearDuration(a,s.id))+" ")]):[e._v(" - ")]],2):e._e()}),e._l(e.monthRange,function(a){return e.detailLevel==="month"?t("td",{key:`month-${a}-${s.id}`,staticClass:"time month",class:{selected:e.isMonthSelected(s.id,e.year,a)}},[e.monthDuration(a,s.id)>0?t("router-link",{staticClass:"duration",attrs:{to:e.getMonthDetailRoute(s,e.year,a)}},[e._v(" "+e._s(e.monthDuration(a,s.id))+" ")]):[e._v(" - ")]],2):e._e()}),e._l(e.weekRange,function(a){return e.detailLevel==="week"?t("td",{key:`week-${a}-${s.id}`,staticClass:"daytime",class:{selected:e.isWeekSelected(s.id,e.year,a)}},[e.weekDuration(a,s.id)>0?t("router-link",{staticClass:"duration",class:{warning:e.weekDuration(a,s.id)>5*e.organisation.hours_by_day},attrs:{to:e.getWeekDetailRoute(s,e.year,a)}},[e._v(" "+e._s(e.weekDuration(a,s.id))+" ")]):[e._v(" - ")]],2):e._e()}),e._l(e.dayRange,function(a){return e.detailLevel==="day"?t("td",{key:`day-${a}-${s.id}`,staticClass:"daytime",class:{weekend:e.isWeekend(e.year,e.month,a),selected:e.isDaySelected(s.id,e.year,e.month,a)}},[e.dayDuration(a,s.id)>0?t("router-link",{staticClass:"duration",attrs:{to:e.getDayDetailRoute(s,e.year,e.month,a)}},[e._v(" "+e._s(e.dayDuration(a,s.id))+" ")]):e.isDayOff(s.id,a)?[e._v(" "+e._s(e.$t("timesheets.off").toUpperCase())+" ")]:[e._v(" - ")]],2):e._e()}),t("td",{staticClass:"actions"})],2)}),0)])]),t("table-info",{attrs:{"is-loading":e.isLoading,"is-error":e.isError}}),e.isLoading?e._e():t("p",{staticClass:"has-text-centered footer-info"},[e._v(" "+e._s(e.people.length)+" "+e._s(e.$tc("people.persons",e.people.length))+" ")])],1)},E=[],B=d(N,W,E,!1,null,"84058e0c",null,null);const A=B.exports,H={name:"time-spent-task-list",components:{TableInfo:m,ProductionName:S,TaskTypeName:x},data(){return{projectNames:{}}},props:{tasks:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},isLoadingError:{type:Boolean,default:!1}},computed:{...u(["productionMap","taskTypeMap"]),projects(){const i={};return[...this.tasks].sort(D.firstBy("project_name")).forEach(t=>{i[t.project_id]||(i[t.project_id]={}),i[t.project_id][t.task_type_id]||(i[t.project_id][t.task_type_id]=[]);let s=t.entity_name;["Shot","Sequence"].includes(t.entity_type_name)?(s=`${t.sequence_name} / ${s}`,t.episode_name&&(s=`${t.episode_name} / ${s}`)):s=`${t.entity_type_name} / ${s}`,i[t.project_id][t.task_type_id].push({id:t.task_id,project_id:t.project_id,task_type_id:t.task_type_id,name:s,duration:t.duration})}),Object.keys(i).forEach(t=>{Object.keys(i[t]).forEach(s=>{i[t][s]=p(i[t][s])})}),i}},methods:{getTaskPath(i){const e=this.productionMap.get(i.project_id);if(!e||e.project_status_name==="Closed")return"";const t=e.production_type==="tvshow",s={id:e.first_episode_id};return I(i,null,t,s,this.taskTypeMap)},onBodyScroll(i,e){this.$refs.headerWrapper.style.left=`-${e.scrollLeft}px`}},watch:{tasks(){this.projectNames=this.tasks.reduce((i,e)=>{const t=this.productionMap.get(e.project_id),s=(t==null?void 0:t.project_status_name)==="Closed"?" (closed)":"";return i[e.project_id]=e.project_name+s,i},{})}}};var F=function(){var e=this,t=e._self._c;return t("div",{staticClass:"data-list"},[t("table-info",{attrs:{"is-loading":e.isLoading,"is-error":e.isLoadingError}}),t("div",{staticClass:"aggregated-time-spents"},e._l(Object.keys(e.projects),function(s){return t("div",{key:s,staticClass:"by-project"},[e.projectNames[s]?t("production-name",{attrs:{production:{id:s,name:e.projectNames[s]}}}):e._e(),e._l(Object.keys(e.projects[s]),function(a){return t("div",{key:a,staticClass:"by-task-type-id"},[t("task-type-name",{attrs:{"task-type":e.taskTypeMap.get(a)}}),t("div",{staticClass:"table-body"},[t("table",{staticClass:"datatable"},[t("tbody",{staticClass:"datatable-body"},e._l(e.projects[s][a],function(o){return t("tr",{key:o.id,staticClass:"by-task-type-id datatable-row"},[t("router-link",{attrs:{to:e.getTaskPath(o)}},[t("td",{staticClass:"name"},[e._v(" "+e._s(o.name)+" ")]),t("td",{staticClass:"duration"},[e._v(e._s(o.duration/60))])])],1)}),0)])])],1)})],2)}),0)],1)},U=[],z=d(H,F,U,!1,null,"6eb075ce",null,null);const X=z.exports,G={name:"people-timesheet-info",components:{PageTitle:y,PeopleAvatar:c,TimeSpentTaskList:X,XIcon:M},props:{person:{type:Object,default:()=>{}},year:{type:Number,default:0},month:{type:Number,default:0},week:{type:Number,default:0},day:{type:Number,default:0},isLoading:{type:Boolean,default:!1},isLoadingError:{type:Boolean,default:!1},tasks:{type:Array,default:()=>[]},dayOffCount:{type:Number,default:0}},computed:{startDay(){return r().day("Monday").year(this.year).week(this.week).date()},endDay(){return r().day("Monday").year(this.year).week(this.week).add(6,"days").date()},weekMonth(){return r().day("Monday").year(this.year).week(this.week).format("MMM")},monthString(){return h(this.month)},isYearInfo(){return!this.isMonthInfo&&!this.isWeekInfo&&!this.isDayInfo},isMonthInfo(){return this.$route.path.indexOf("month")>0},isWeekInfo(){return this.$route.path.indexOf("week")>0},isDayInfo(){return this.$route.path.indexOf("day")>0},closeRoute(){return this.isMonthInfo?{name:"timesheets-month",params:{year:this.year}}:this.isWeekInfo?{name:"timesheets-week",params:{year:this.year}}:this.isDayInfo?{name:"timesheets-day",params:{year:this.year,month:this.month}}:{name:"timesheets"}}},methods:{onCloseClicked(){this.$emit("close")}}};var J=function(){var e=this,t=e._self._c;return t("div",{staticClass:"people-timesheet-info"},[t("div",{staticClass:"close"},[t("router-link",{staticClass:"close-button",attrs:{to:e.closeRoute}},[t("x-icon")],1)],1),t("div",{staticClass:"flexrow"},[t("people-avatar",{staticClass:"flexrow-item",attrs:{person:e.person,"is-lazy":!1}}),t("page-title",{staticClass:"flexrow-item",attrs:{text:e.person.full_name}})],1),e.isYearInfo?t("div",{staticClass:"info-date"},[e._v(" "+e._s(e.year)+" ")]):e._e(),e.isMonthInfo?t("div",{staticClass:"info-date"},[e._v(e._s(e.monthString)+" "+e._s(e.year))]):e.isWeekInfo?t("div",{staticClass:"info-date"},[e._v(" "+e._s(e.$t("main.week"))+" "+e._s(e.week)+", "+e._s(e.startDay)+" - "+e._s(e.endDay)+" "+e._s(e.weekMonth)+" "+e._s(e.year)+" ")]):e._e(),e.isDayInfo?e.isDayInfo?t("div",{staticClass:"info-date"},[e._v(" "+e._s(e.day)+" "+e._s(e.monthString)+" "+e._s(e.year)+" ")]):e._e():t("div",{staticClass:"info-day-off"},[e._v(" "+e._s(e.dayOffCount)+" "+e._s(e.$tc("timesheets.nb_days_off",e.dayOffCount))+" ")]),t("time-spent-task-list",{staticClass:"time-spent-list",attrs:{tasks:e.tasks,"is-loading":e.isLoading,"is-error":e.isLoadingError}})],1)},K=[],V=d(G,J,K,!1,null,"b3516c0b",null,null);const Q=V.exports,Z={name:"timesheets",components:{ButtonSimple:Y,ButtonHrefLink:j,Combobox:O,ComboboxProduction:R,PageTitle:y,PeopleTimesheetList:A,PeopleTimesheetInfo:Q},data(){return{detailOptions:[{label:"Day",value:"day"},{label:"Week",value:"week"},{label:"Month",value:"month"},{label:"Year",value:"year"}],unitOptions:[{label:"Hour",value:"hour"},{label:"Day",value:"day"}],detailLevelString:"day",detailLevel:"day",productionIdString:"",productionId:"",yearString:`${r().year()}`,monthString:`${r().month()+1}`,unit:"hour",currentYear:r().year(),currentMonth:r().month()+1,currentWeek:r().week(),currentDay:r().date(),currentPerson:this.getCurrentPerson(),isLoading:!1,isLoadingError:!1,dayOffCount:0,isInfoLoading:!1,isInfoLoadingError:!1,showInfo:!0,tasks:[]}},created(){this.isLoading=!0,this.loadProductions(),this.people.length===0?this.loadPeople(()=>{this.loadRoute()}):this.loadRoute()},mounted(){const i=this.$route.query.productionId;i&&(this.silent=!0,this.productionId=i,this.productionIdString=i,this.reloadTimesheet().then(()=>{this.silent=!1}))},computed:{...u(["isCurrentUserAdmin","isCurrentUserManager","organisation","people","productions","personMap","timesheet"]),productionList(){const i=p([...this.productions]).map(e=>{const t=e.project_status_name==="Closed"?" (closed)":"";return{...e,name:e.name+t}});return[{id:"",name:this.$t("main.all")},...i]},filteredPeople(){return this.people.filter(i=>{const e=Object.keys(this.timesheet);let t=!1,s=0;do this.timesheet[e[s]]&&(t=this.timesheet[e[s]][i.id]!==void 0),s++;while(!t&&s<e.length);return t})},yearOptions(){const e=r().year();return l(2018,e).map(t=>({label:t,value:`${t}`}))},monthOptions(){const i=`${r().year()}`,e=1,t=r().month()+1;let s=l(e,12);return i===this.yearString&&(s=l(e,t)),s.map(a=>({label:h(a),value:`${a}`}))}},methods:{...T(["loadPeople","loadProductions","loadAggregatedPersonDaysOff","loadAggregatedPersonTimeSpents","loadTimesheets"]),reloadTimesheet(){return this.isLoading=!0,this.isLoadingError=!1,this.loadTimesheets({detailLevel:this.detailLevel,year:this.currentYear,month:this.currentMonth,productionId:this.productionId}).then(()=>{this.isLoading=!1}).catch(i=>{console.error(i),this.isLoading=!1,this.isLoadingError=!0})},showSideInfo(){this.showInfo=!0},hideSideInfo(){this.showInfo=!1},loadRoute(){this.$options.silent=!0;const{month:i,year:e,week:t,day:s}=this.$route.params,a=`${this.productionId}`,o=`${this.detailLevel}`,f=`${this.currentMonth}`,_=`${this.currentYear}`;this.$route.path.indexOf("week")>0&&(this.detailLevel="week"),this.$route.path.indexOf("month")>0&&(this.detailLevel="month"),this.$route.path.indexOf("day")>0&&(this.detailLevel="day"),this.$route.path.indexOf("year")>0&&(this.detailLevel="year"),this.currentPerson=this.getCurrentPerson(),this.detailLevelString=this.detailLevel,i&&(this.currentMonth=Number(i),this.monthString=`${i}`),e&&(this.currentYear=Number(e),this.yearString=`${e}`),t&&(this.currentWeek=Number(t),this.weekString=`${t}`),s&&(this.currentDay=Number(s)),this.productionId=this.$route.query.productionId||"";const g=o!==this.detailLevel,v=f.localeCompare(`${this.currentMonth}`)!==0,$=_.localeCompare(`${this.currentYear}`)!==0,k=a.localeCompare(`${this.productionId}`)!==0;this.$nextTick(()=>{this.$options.silent=!1}),this.$route.path.indexOf("person")>0?(this.showSideInfo(),this.loadAggregate()):this.hideSideInfo(),(this.isLoading||v||$||g||k)&&this.reloadTimesheet()},loadAggregate(){this.isInfoLoading=!0,this.isInfoLoadingError=!1,this.tasks=[],this.loadAggregatedPersonTimeSpents({personId:this.$route.params.person_id,detailLevel:this.detailLevel,year:this.$route.params.year,month:this.$route.params.month,week:this.$route.params.week,day:this.$route.params.day,productionId:this.productionId}).then(i=>(this.tasks=i.filter(e=>e.duration>0),this.loadAggregatedPersonDaysOff({personId:this.$route.params.person_id,detailLevel:this.detailLevel,year:this.$route.params.year,month:this.$route.params.month,week:this.$route.params.week}))).then(i=>{this.dayOffCount=i.length,this.isInfoLoading=!1}).catch(i=>{console.error(i),this.isInfoLoadingError=!0})},getCurrentPerson(){const i=this.$route.params.person_id;return i&&this.personMap?this.personMap.get(i):{}},exportTimesheet(){const i=["timesheet",this.detailLevel,this.currentYear];this.detailLevel==="day"&&i.push(this.currentMonth);const e=q.slugify(i.join("_"));P.generateTimesheet(e,this.timesheet,this.filteredPeople,this.unit,this.organisation,this.detailLevel,this.currentYear,this.currentMonth,r().month()+1,r().year(),r().week())}},watch:{detailLevelString(){this.silent||this.detailLevel!==this.detailLevelString&&(this.detailLevelString==="month"?this.$router.push({name:"timesheets-month",params:{year:this.currentYear},query:this.$route.query}):this.detailLevelString==="week"?this.$router.push({name:"timesheets-week",params:{year:this.currentYear},query:this.$route.query}):this.detailLevelString==="day"?this.$router.push({name:"timesheets-day",params:{year:this.currentYear,month:this.currentMonth},query:this.$route.query}):this.detailLevelString==="year"&&this.$router.push({name:"timesheets-year",params:{year:this.currentYear},query:this.$route.query}))},yearString(){if(this.silent)return;const i=Number(this.yearString),e=r().month();this.currentYear!==i&&(this.detailLevel==="month"?this.$router.push({name:"timesheets-month",params:{year:i},query:this.$route.query}):this.detailLevel==="week"?this.$router.push({name:"timesheets-week",params:{year:i},query:this.$route.query}):this.$router.push({name:"timesheets-day",params:{year:i,month:Math.min(Number(this.monthString),e)},query:this.$route.query}))},monthString(){this.silent||this.currentMonth!==Number(this.monthString)&&this.$router.push({name:"timesheets-day",params:{year:this.currentYear,month:Number(this.monthString)},query:this.$route.query})},productionIdString(){this.silent||this.$router.push({query:{productionId:this.productionIdString}})},$route(){this.loadRoute()}},metaInfo(){return{title:`${this.$t("timesheets.title")} - Kitsu`}}};var ee=function(){var e=this,t=e._self._c;return t("div",{staticClass:"columns fixed-page"},[t("div",{staticClass:"column main-column"},[t("div",{staticClass:"timesheets page"},[t("div",{staticClass:"page-header flexrow"},[t("page-title",{staticClass:"flexrow-item title",attrs:{text:e.$t("timesheets.title")}}),t("combobox-production",{staticClass:"flexrow-item",attrs:{label:e.$t("main.production"),"production-list":e.productionList},model:{value:e.productionIdString,callback:function(s){e.productionIdString=s},expression:"productionIdString"}}),t("combobox",{staticClass:"flexrow-item",attrs:{label:e.$t("timesheets.detail_level"),options:e.detailOptions},model:{value:e.detailLevelString,callback:function(s){e.detailLevelString=s},expression:"detailLevelString"}}),e.detailLevelString!=="year"?t("combobox",{staticClass:"flexrow-item",attrs:{label:e.$t("timesheets.year"),options:e.yearOptions},model:{value:e.yearString,callback:function(s){e.yearString=s},expression:"yearString"}}):e._e(),e.detailLevelString==="day"?t("combobox",{staticClass:"flexrow-item",attrs:{label:e.$t("timesheets.month"),options:e.monthOptions},model:{value:e.monthString,callback:function(s){e.monthString=s},expression:"monthString"}}):e._e(),t("combobox",{staticClass:"flexrow-item",attrs:{label:e.$t("timesheets.unit"),options:e.unitOptions},model:{value:e.unit,callback:function(s){e.unit=s},expression:"unit"}}),t("div",{staticClass:"filler"}),t("button-simple",{staticClass:"flexrow-item",attrs:{title:e.$t("timesheets.export_timesheet"),icon:"export"},on:{click:e.exportTimesheet}}),e.isCurrentUserAdmin?t("button-href-link",{staticClass:"flexrow-item",attrs:{title:e.$t("timesheets.export_timespents"),path:"/api/export/csv/time-spents.csv",icon:"export-lines"}}):e._e()],1),t("people-timesheet-list",{staticClass:"data-list",attrs:{people:e.filteredPeople,timesheet:e.timesheet,"detail-level":e.detailLevel,month:e.currentMonth,year:e.currentYear,unit:e.unit,"is-loading":e.isLoading,"is-error":e.isLoadingError}})],1)]),e.showInfo?t("div",{staticClass:"column side-column"},[t("people-timesheet-info",{attrs:{person:e.currentPerson,production:e.productionId,year:e.currentYear,month:e.currentMonth,week:e.currentWeek,day:e.currentDay,unit:e.unit,"is-loading":e.isInfoLoading,"is-loading-error":e.isInfoLoadingError,tasks:e.tasks,"day-off-count":e.dayOffCount},on:{close:e.hideSideInfo}})],1):e._e()])},te=[],se=d(Z,ee,te,!1,null,"4c80c3fa",null,null);const re=se.exports;export{re as default};
//# sourceMappingURL=Timesheets-8tx4hq8D.js.map
